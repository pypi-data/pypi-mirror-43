from . import nwchem
from ..testdata import get_json
import unittest
import re


# The reference result for the Si section of pc-2
# in Q-Chem format
reference_si = """
  Si  S
     120040.0000000     0.000160750000
      17991.0000000     0.00124720000
       4094.8000000     0.00650400000
       1159.6000000     0.0266650000
        378.0000000     0.0888160000
        135.9300000     0.229320000
         52.4110000     0.400250000
         20.9270000     0.338280000
          7.7130000     0.0655120000
  Si  S
      17991.0000000    -6.84030000E-07
       4094.8000000    -2.11240000E-06
       1159.6000000    -6.91570000E-05
        378.0000000    -0.000480800000
        135.9300000    -0.00416940000
         52.4110000    -0.0176740000
         20.9270000    -0.0428910000
          7.7130000     0.0453680000
          3.1604000     0.139040000
  Si  S
       4094.8000000    -3.98970000E-06
       1159.6000000    -5.02030000E-05
        378.0000000    -0.000575530000
        135.9300000    -0.00415240000
         52.4110000    -0.0204370000
         20.9270000    -0.0469980000
          7.7130000     0.0439860000
          3.1604000     0.339570000
          1.2348000     0.350380000
  Si  S
          0.2677500     1.00000000
  Si  S
          0.0940670     1.00000000
  Si  P
        677.1300000     0.00109250000
        160.6700000     0.00896010000
         51.5850000     0.0447440000
         18.9480000     0.147480000
          7.6163000     0.314800000
          3.1317000     0.413390000
          1.2703000     0.264400000
  Si  P
        160.6700000     7.90140000E-06
         51.5850000    -0.000136130000
         18.9480000    -0.000903780000
          7.6163000    -0.00558630000
          3.1317000    -0.0101410000
          1.2703000     0.0186610000
          0.4333200     0.288900000
  Si  P
          0.1608800     1.00000000
  Si  P
          0.0548830     1.00000000
  Si  D
          1.6800000     1.00000000
  Si  D
          0.3800000     1.00000000
  Si  F
          0.5400000     1.00000000
"""


# The reference result for the C section of pc-2
# in Q-Chem format
reference_c = """
  C  S
       7857.1000000     0.000568250000
       1178.7000000     0.00439150000
        268.3200000     0.0225040000
         75.9480000     0.0866530000
         24.5590000     0.244050000
          8.6212000     0.441480000
          3.1278000     0.353320000
  C  S
       1178.7000000    -5.94920000E-07
        268.3200000    -6.27480000E-05
         75.9480000    -0.000757730000
         24.5590000    -0.00733080000
          8.6212000    -0.0389320000
          3.1278000    -0.0889080000
          0.8220200     0.216890000
  C  S
          0.3301700     1.00000000
  C  S
          0.1146300     1.00000000
  C  P
         33.7750000     0.00602940000
          7.6766000     0.0432280000
          2.2357000     0.163010000
          0.7644700     0.365040000
  C  P
          0.2623200     1.00000000
  C  P
          0.0846380     1.00000000
  C  D
          1.4000000     1.00000000
  C  D
          0.4500000     1.00000000
  C  F
          0.9500000     1.00000000
"""


def strip_comments(string):
    lines = string.split("\n")
    return "\n".join(l for l in lines if l[0] != "#")


class TestNWChem(unittest.TestCase):
    """
    Test dumping NWChem basis section
    """
    def test_dumps(self):
        data = get_json("pc-2")
        dump = nwchem.dumps(data)

        lines = dump.strip().split("\n")
        assert lines[0] == "basis"
        assert lines[-1] == "end"

        # Silicon
        re_si = re.compile(r"( *Si .*?)P ", re.MULTILINE + re.DOTALL)
        part_si = re.search(re_si, dump)
        assert part_si
        assert reference_si.strip() == strip_comments(part_si.group(1).strip())

        # Carbon
        re_c = re.compile(r"( *C .*?)N ", re.MULTILINE + re.DOTALL)
        part_c = re.search(re_c, dump)
        assert part_c
        assert reference_c.strip() == strip_comments(part_c.group(1).strip())
