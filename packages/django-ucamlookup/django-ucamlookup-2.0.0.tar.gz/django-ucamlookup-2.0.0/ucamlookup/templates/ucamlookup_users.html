{% load dictionary_tag %}
<script>
    $(document).ready(function() {
        /**
         * ID of the last AJAX search request we sent.
         */
        var searchId_u = 0;

        $("#{{ input_tag_id }}").select2({
            placeholder: '{{ placeholder|default:"Search for user" }}',
            minimumInputLength: 3,
            multiple: {{ multiple }},
            ajax: {
                url: "{%  url 'ucamlookup_find_people' %}",
                dataType: 'json',
                data: function (term, page) {
                    return {
                        query: term,
                        searchId_u: ++searchId_u
                    };
                },
                results: function (data, page) {
                    if (data.searchId_u != searchId_u)
                        return;
                    return {results: data.persons};
                }
            },
            formatResult: function(person, container, wuery, escapeMarkup) {
                return escapeMarkup(person.visibleName+" ("+person.crsid+") ");
            },
            formatSelection: function(person, container, escapeMarkup) {

                if (person && person.crsid) {
                    return escapeMarkup(person.visibleName+" ("+person.crsid+") ");
                }
                return this.placeholder;
            },
            id: function(person) {
                return person.crsid;
            },
            dropdownCssClass: "bigdrop", // apply css that makes the dropdown taller
        });

        {% if user_list %}
            $("#{{ input_tag_id }}").select2("data", [
                {% for authorised_user in lookup_lists|get_item:user_list %}
                    {
                        crsid: "{{ authorised_user.username }}",
                        visibleName: "{{ authorised_user.last_name }}",
                        {% if request.user.username == authorised_user.username %}
                            locked: true
                        {% endif %}
                    },
                {% endfor %}
            ]);
        {% endif %}

        {% if single_user %}
            $("#{{ input_tag_id }}").select2("data", {
                crsid: "{{ single_user.username }}",
                visibleName: "{{ single_user.last_name }}"
            });
        {% endif %}

        {% if disabled %}
            $("#{{ input_tag_id }}").select2("enable", false);
        {% endif %}
    });
</script>
